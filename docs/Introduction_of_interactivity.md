The introduction of interactivity between mapper and cvml
=========================================================

This document is the brief introduction of how mapper and cvml communicates with each other. Generally, mapper sends signal to wake up cvml (an EMR cluster), then cvml will finish all the work that it needs to be done (including extract features, run model, apply model, and save the sites with high uncertainty (F sites) into `incoming_names` table in database), which is called one iteration. When the work is done, cvml will terminate itself. Once the cvml is terminated, mapper will save all the new names in `incoming_names` into `kml_data` table in database. So far, the system could allow the workers to start to work on the sites with high uncertainty (F sites).

The most related scripts includes `generate_consensus_daemon.py`, `consensus_map_generator.R`, `run_cvml.py`, `cvml_mapper_connection.py`, and `register_f_sites.py`. There are other scripts that connects to this as well, including `select_n_sites.py`, `create_hit_daemon.py`, and `cleanup_absent_worker.py`.

The general workflow is shown as follow:

![](interactivity.png?raw=true)

Reminder of different types of sites
------------------------------------

-   F sites: sites with high uncertainty generated by `cvml`.
-   N sites: normal sites to keep the worker busy.
-   Q sites: sites for qualification
-   I sites: special Q sites for the qualification test before a worker start to work.

Daemon `generate_consensus_daemon.py`
-------------------------------------

It is the major script to connect mapper and cvml, which is an alive daemon in mapper. It is watching the `incoming_names` table and `kml_data` table in our database.

There is an relationship between these two tables. All the sites in `incoming_names` are in `kml_data` as F sites. The `incoming_names` is the container to receive sites getting from `cvml`, but also an launcher of signal to trigger `cvml`.

### Generate consensus maps

In `incoming_names`, `processed = FALSE` means this site is not finished by the workers yet. But when `mapped_count = mappers_needed` in `kml_data`, it means the site is finished by the workers. So `generate_consensus_daemon.py` will call the `consensus_map_generator.R` to generate consensus map for this site, saving an image into S3 bucket (activemapper/labels). Once it is done, `generate_consensus_daemon.py` will change the `processed` to `TRUE` for this site in `incoming_names`. This is a loop for one site.

### Trigger cvml

After all sites in `incoming_names` finish the loop above, `generate_consensus_daemon.py` will call `run_cvml.py`. It is a script to run `Terraform` which is a binary to create an EMR cluster on AWS. `run_cvml.py` will get back the id of this EMR cluster when it is created successully.

### `cvml`

The `cvml` is a self-terminated EMR cluster. Once it is created, it will download and run the related scripts from S3 bucket (`cvml_mapper_connection.py` for example, only mention it because this is the only script used for testing interactivity). As designed, `cvml` will finish a Ramdom Forest model, apply this model to some new sites, then get a bunch of sites with highest uncertainty and save them back to `incoming_names` table. After all these are done, `cvml` will terminate itself. This is an iteration for active learning.

### Getting sites gived back from `cvml`

As mentioned before, when `cvml` is created, we get back the id of the cluster. So after `generate_consensus_daemon.py` triggers the `cvml`, it keeps watching the state of this cluster using the id. After the state of this cluser becomes `TERMINATED`, `generate_consensus_daemon.py` then call `register_f_sites.py` to save all the new sites in `incoming_names` table into `kml_data` table as F sites.

So far, one bout of interactivity is finished.

Daemon `select_n_sites.py`
--------------------------

Because the `cvml` could spend a long time to run the model, the system could be out of F sites for a while. When this happens, the system could give the workers N sites to work on. So we should make sure there are always N sites there to keep the workers busy. When the system is out of N sites, `select_n_sites.py` will grab a bunch of sites from `master_grid` table in database and insert them into `kml_data` as new N sites.

Daemon `create_hit_daemon.py` and `cleanup_absent_worker.py`
------------------------------------------------------------

These two daemons are working to create assignments for the workers and keep the system clean.
